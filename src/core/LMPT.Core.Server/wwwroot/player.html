<!doctype html>
<html>

<head>
    <title>Player</title>

    <script>
        if (typeof module === 'object') {
            window.module = module;
            module = undefined;
        }
    </script>

    <!-- jQuery v3.3.1 -->
    <script src="js/external/jquery.min.js"></script>
    <!-- hls.js light v0.12.2 -->
    <script src="js/external/hls.light.min.js"></script>

    <script>
        const {
            ipcRenderer,
            remote
        } = require('electron'), LiveMe = remote.getGlobal('LiveMe');
        const prettydate = require('pretty-date');

        var videoid = '',
            userid = '';

        document.addEventListener('keydown', (e) => {
            const video = document.getElementById('video')

            switch (e.code;) {

                case 'Space';: // Space
                    video.paused ? video.play() : video.pause();
                    break;

                case 'Comma';:
                    if (video.paused) video.currentTime -= 0.05;
                    break;

                case 'Period';:
                    if (video.paused) video.currentTime += 0.05;
                    break;

                case 'KeyK';:
                    video.currentTime -= 10;
                    break;

                case 'KeyL';:
                    video.currentTime += 10;
                    break;

                case 'ArrowRight';:
                    video.currentTime += 1;
                    break;

                case 'ArrowLeft';:
                    video.currentTime -= 1;
                    break
            }

        })
        $(function() {

            var t = window.location.href.split('?');
            $('header h1').html(t[1]);
            document.title = t[1];

            LiveMe.getVideoInfo(t[1])
                .then(vid => {
                    videoid = vid.vid;
                    userid = vid.userid;

                    let properSource = LiveMe.pickProperVideoSource(vid);

                    if (properSource === '') {
                        let endedAt = new Date(LiveMe.getVideoEndDate(vid));

                        $('#video').hide();
                        $('.player-msg').html('<h3>Video not found!</h3>' +
                                              '<br><br>' +
                                              `This live stream ended <strong>${prettydate.format(endedAt)}</strong>.<br>` +
                                              'The replay might still being generated or was deleted.' +
                                              '<br><br>' +
                                              'Try again later, maybe?').show();
                        $('.mid-container').show();

                        return
                    }

                    var video = document.getElementById('video');
                    var hls = new Hls();
                    hls.loadSource(properSource);
                    hls.attachMedia(video);
                    hls.on(Hls.Events.MANIFEST_PARSED, function() {
                        video.play();
                    });
        })
        });

        function closeWindow() {
            window.close();
        }

        function showUser() {
            ipcRenderer.send('show-user', {
                userid: userid
            });
        }

        function downloadReplay() {
            ipcRenderer.send('download-replay', { videoid: videoid })
        }
    </script>

    <link rel="stylesheet" href="css/player.css">

</head>

<body>
    <header class="small">
        <h1></h1>
        <div class="control-buttons">
            <a onClick="downloadReplay()" title="Download Replay">
                <svg class="svg-icon" viewBox="0 0 20 20">
                    <path d="M17.064,4.656l-2.05-2.035C14.936,2.544,14.831,2.5,14.721,2.5H3.854c-0.229,0-0.417,0.188-0.417,0.417v14.167c0,0.229,0.188,0.417,0.417,0.417h12.917c0.229,0,0.416-0.188,0.416-0.417V4.952C17.188,4.84,17.144,4.733,17.064,4.656M6.354,3.333h7.917V10H6.354V3.333z M16.354,16.667H4.271V3.333h1.25v7.083c0,0.229,0.188,0.417,0.417,0.417h8.75c0.229,0,0.416-0.188,0.416-0.417V3.886l1.25,1.239V16.667z M13.402,4.688v3.958c0,0.229-0.186,0.417-0.417,0.417c-0.229,0-0.417-0.188-0.417-0.417V4.688c0-0.229,0.188-0.417,0.417-0.417C13.217,4.271,13.402,4.458,13.402,4.688"></path>
                </svg>
            </a>
            <a onClick="showUser()" title="View User">
                <svg class="svg-icon" viewBox="0 0 20 20">
                    <path d="M12.075,10.812c1.358-0.853,2.242-2.507,2.242-4.037c0-2.181-1.795-4.618-4.198-4.618S5.921,4.594,5.921,6.775c0,1.53,0.884,3.185,2.242,4.037c-3.222,0.865-5.6,3.807-5.6,7.298c0,0.23,0.189,0.42,0.42,0.42h14.273c0.23,0,0.42-0.189,0.42-0.42C17.676,14.619,15.297,11.677,12.075,10.812 M6.761,6.775c0-2.162,1.773-3.778,3.358-3.778s3.359,1.616,3.359,3.778c0,2.162-1.774,3.778-3.359,3.778S6.761,8.937,6.761,6.775 M3.415,17.69c0.218-3.51,3.142-6.297,6.704-6.297c3.562,0,6.486,2.787,6.705,6.297H3.415z"></path>
                </svg>
            </a>
            <a  class="close" onClick="closeWindow()">
                <svg class="svg-icon" viewBox="0 0 20 20">
                    <path d="M10.185,1.417c-4.741,0-8.583,3.842-8.583,8.583c0,4.74,3.842,8.582,8.583,8.582S18.768,14.74,18.768,10C18.768,5.259,14.926,1.417,10.185,1.417 M10.185,17.68c-4.235,0-7.679-3.445-7.679-7.68c0-4.235,3.444-7.679,7.679-7.679S17.864,5.765,17.864,10C17.864,14.234,14.42,17.68,10.185,17.68 M10.824,10l2.842-2.844c0.178-0.176,0.178-0.46,0-0.637c-0.177-0.178-0.461-0.178-0.637,0l-2.844,2.841L7.341,6.52c-0.176-0.178-0.46-0.178-0.637,0c-0.178,0.176-0.178,0.461,0,0.637L9.546,10l-2.841,2.844c-0.178,0.176-0.178,0.461,0,0.637c0.178,0.178,0.459,0.178,0.637,0l2.844-2.841l2.844,2.841c0.178,0.178,0.459,0.178,0.637,0c0.178-0.176,0.178-0.461,0-0.637L10.824,10z"></path>
                </svg>
            </a>
        </div>
    </header>
    <main class="has-small-header" style="display: block; overflow: hidden;">
        <div class="mid-container" style="display: none">
            <span class="player-msg"></span>
        </div>
        <video id="video" controls></video>
    </main>
</body>

</html>
